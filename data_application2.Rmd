---
title: "Data Application 2"
author: "Elizabeth Chase"
date: "12/7/2021"
output: pdf_document
---

```{r setup}
library(tidyverse)
library(HPR)
library(mgcv)
library(gamlss)
library(kableExtra)

pca_overall <- read_delim("prostate_incidence.txt", delim = "\t", col_names= FALSE)
pca_overall <- pca_overall[-1,]
colnames(pca_overall) <- c("Year", "Rate", "Cases", "Popn")

pca_afa <- read_delim("pca_afa_men.txt", delim = "\t", col_names= FALSE)
pca_afa <- pca_afa[-1,]
colnames(pca_afa) <- c("Year", "Rate", "Cases", "Popn")

pca_nonafa <- data.frame("Year" = pca_overall$Year, "Cases" = pca_overall$Cases-pca_afa$Cases, "Popn" = pca_overall$Popn - pca_afa$Popn, "Black" = 0)

pca_afa$Black <- 1

pca_final <- rbind(pca_nonafa, dplyr::select(pca_afa, -Rate))
pca_final$Rate <- 100000*(pca_final$Cases/pca_final$Popn)

pca_final$Year <- pca_final$Year + 1974
```

## Descriptives

This dataset contains `r nrow(pca_final)` observations on the incidence of prostate cancer in the United States on African-American men and non-African American men, 1975-2017. In this case, observations are equally spaced, and there are two observations at each timepoint (one for African-American men; one for men who aren't African-American). 

Here's what the data look like:
```{r descript, echo = FALSE}
ggplot(data = pca_final) + geom_point(aes(x = Year, y = Rate, color = factor(Black))) + theme_bw() + xlab("Year") + ylab("Prostate Cancer Incidence per 100,000") + scale_color_manual(name = "Race", labels = c("Not African-American", "African-American"), values = c("mediumpurple4", "darkred"))
```

## Model Results

First, a model that does not include race information:
```{r modelresults, echo=FALSE}
X <- as.matrix(pca_final$Year, ncol = 1)
y <- pca_final$Rate
Z <- as.matrix(pca_final$Black)

uni_hpr1 <- hpr(y = y, X = X, family = "gaussian")
curve_estim1 <- get_f(uni_hpr1, alpha = 0.05)
curve_estim1$Model <- "HPR"

uni_gpr1 <- gam(Rate ~ s(Year, bs = "gp"), data = pca_final)
gp_fit_lin <- predict(uni_gpr1, newdata = pca_final, type = "link", se.fit = TRUE)

mycurvefits <- data.frame("Median" = gp_fit_lin$fit, "Lower" = gp_fit_lin$fit - 1.96*gp_fit_lin$se.fit, "Upper" = gp_fit_lin$fit + 1.96*gp_fit_lin$se.fit, "x" = pca_final$Year, "Mean" = NA);
mycurvefits$Model <- "GPR"

loessfit <- predict(loess(Rate ~ Year, data = pca_final), se = T)
mycurvefits_loess <- data.frame("Median" = loessfit$fit, "Lower" = loessfit$fit - 1.96*loessfit$se.fit, "Upper" = loessfit$fit + 1.96*loessfit$se.fit, "x" = pca_final$Year, "Mean" = NA);
mycurvefits_loess$Model <- "LOESS"

fulldat <- rbind(curve_estim1, mycurvefits, mycurvefits_loess)

unadj_plot <- ggplot() + geom_line(data = fulldat, aes(x = x, y = Median, color = Model), size=1) + geom_ribbon(data = fulldat, aes(x = x, ymin = Lower, ymax = Upper, fill = Model), alpha = 0.2) + geom_point(data = pca_final, aes(x = Year, y = Rate)) + theme_bw() + xlab("Year") + ylab("Prostate Cancer Incidence per 100,000") + scale_color_manual(values = c("mediumpurple4", "darkred", "grey74")) + scale_fill_manual(values = c("mediumpurple4", "darkred", "grey74"))


unadj_plot
```

Now, a model that includes race as a categorical predictor:
```{r modelresults2, echo=FALSE}
uni_hpr2 <- hpr(y = y, X = X, Z = Z, family = "gaussian")
mypreds <- get_preds(uni_hpr2, alpha = 0.05)
mypreds$Black <- pca_final$Black
mypreds$Model <- "HPR"
mypreds$x <- pca_final$Year

uni_gpr2 <- gam(Rate ~ s(Year, bs = "gp") + Black, data = pca_final)
gp_fit_lin <- predict(uni_gpr2, newdata = pca_final, type = "link", se.fit = TRUE)

mycurvefits <- data.frame("Median" = gp_fit_lin$fit, "Lower" = gp_fit_lin$fit - 1.96*gp_fit_lin$se.fit, "Upper" = gp_fit_lin$fit + 1.96*gp_fit_lin$se.fit, "x" = pca_final$Year, "Mean" = NA, "Black" = pca_final$Black, "Model" = "GPR");

loessfit_afa <- predict(loess(Rate ~ Year, data = pca_final[pca_final$Black==1,]), se = T)
loessfit_nonafa <- predict(loess(Rate ~ Year, data = pca_final[pca_final$Black==0,]), se = T)

mycurvefits_loess <- data.frame("Median" = c(loessfit_afa$fit, loessfit_nonafa$fit), "Lower" = c(loessfit_afa$fit - 1.96*loessfit_afa$se.fit, loessfit_nonafa$fit - 1.96*loessfit_nonafa$se.fit), "Upper" = c(loessfit_afa$fit + 1.96*loessfit_afa$se.fit, loessfit_nonafa$fit + 1.96*loessfit_nonafa$se.fit), "x" = pca_final$Year, "Mean" = NA, "Black" = pca_final$Black, "Model" = "LOESS");

fulldat <- rbind(mypreds, mycurvefits, mycurvefits_loess)
pca_final_factor <- pca_final
pca_final_factor$Black <- factor(pca_final_factor$Black, levels = c(0, 1), labels = c("Not African-American", "African-American"))
fulldat$Black <- factor(fulldat$Black, levels = c(0, 1), labels = c("Not African-American", "African-American"))

adj_plot <- ggplot() + geom_line(data = fulldat, aes(x = x, y = Median, color = Model), size=1) + geom_ribbon(data = fulldat, aes(x = x, ymin = Lower, ymax = Upper, fill = Model), alpha = 0.2) + geom_point(data = pca_final_factor, aes(x = Year, y = Rate)) + theme_bw() + xlab("Year") + ylab("Prostate Cancer Incidence per 100,000") + facet_wrap(~factor(Black)) + theme(legend.position="bottom") + scale_color_manual(values = c("mediumpurple4", "darkred", "grey74")) + scale_fill_manual(values = c("mediumpurple4", "darkred", "grey74"))

adj_plot
```
