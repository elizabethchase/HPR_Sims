---
title: "Data Application"
author: "Elizabeth Chase"
date: "11/14/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(HPR)
library(mgcv)
library(gamlss)
library(kableExtra)

rilt_data <- read_csv("~/Desktop/Research/Dissertation/Chapter One/HPR_Sims/Data application/lung_radiotherapy.csv")
```

## Descriptives

This dataset includes `r nrow(rilt_data)`` patients treated with radiotherapy for locally advanced non-small cell lung cancer. These data are all from patients' initial timepoint, without SBRT, and with radiation to the ipsilateral lung (but either left or right lung). 76 of the patients received concurrent chemotherapy, although I don't have data on which patients. 

Lung toxicities were graded between 0 and 5, and then made into a binary variable with toxicities $\geq$ 2 classified as being a toxicity (and grades 0 and 1 being no toxicity). 

Several dosimetrics were considered, but we will focus here on low VQ 20. As I understand it, V is one imaging dosimetric measured after patients inhale something, while Q is another imaging dosimetric measured after patients are injected with something. VQ refers to voxels on both images that were in agreement about whether the voxel of lung tissue received radiation exposure. Low VQ 20 refers to the percentage of voxels that received $\geq 20$ Gy of radiation. 

The paper that Phil shared with me also found that a non-imaging dosimetric called ADL is independently predictive of toxicity in addition to low VQ 20. 

First, some descriptive statistics:
```{r descript, echo = FALSE}
print("Distribution of VQ 20:")
quantile(rilt_data$`low VQ 20`[rilt_data$LungToxicityBool==1])
quantile(rilt_data$`low VQ 20`[rilt_data$LungToxicityBool==0])
quantile(rilt_data$`low VQ 20`)

print("Distribution of ADL:")
quantile(rilt_data$AD2L[rilt_data$LungToxicityBool==1])
quantile(rilt_data$AD2L[rilt_data$LungToxicityBool==0])
quantile(rilt_data$AD2L)

print("Which lung irradiated:")
table(rilt_data$Structure)
table(rilt_data$Structure, rilt_data$LungToxicityBool)

print("Lung Toxicity Distribution (grades 0-5):")
table(rilt_data$`Lung Toxicity Grade`)
table(rilt_data$`Lung Toxicity Grade`, rilt_data$LungToxicityBool)

print("Lung Toxicity Distribution (binary):")
table(rilt_data$LungToxicityBool)

ggplot(data = rilt_data) + geom_point(aes(x = `low VQ 20`, y = LungToxicityBool, color = Structure)) + theme_bw() + ylab("Toxicity (Binary)") + xlab("VQ 20") 

ggplot(data = rilt_data) + geom_point(aes(x = AD2L, y = LungToxicityBool, color = Structure)) + theme_bw() + ylab("Toxicity (Binary)") + xlab("ADL")

ggplot(data = rilt_data) + geom_point(aes(x = AD2L, y = `low VQ 20`, shape = Structure, color = factor(LungToxicityBool))) + theme_bw() + xlab("ADL") + ylab("VQ 20") + guides(color = guide_legend(title = "Toxicty"))
```

## Model Results

At present, I'm fitting two models: one with only VQ20 as an HPR predictor, and another model with VQ20 as the HPR predictor, and with ADL and which lung as linear predictors. Results:
```{r hpr, echo = FALSE}
rilt_data$VQ20 <- rilt_data$`low VQ 20`

X <- as.matrix(rilt_data$`low VQ 20`, ncol = 1)
y <- rilt_data$LungToxicityBool
Z <- as.matrix(cbind(rilt_data$AD2L, as.numeric(rilt_data$Structure=="RIGHT_LUNG-GTV")))

uni_hpr1 <- hpr(y = y, X = X, family = "binomial", monotonic_terms = c(1), monotonic_approach = "abs")
curve_estim1 <- get_f(uni_hpr1, alpha = 0.05)
curve_estim1$Model <- "HPR"

uni_gpr1 <- gam(LungToxicityBool ~ s(VQ20, bs = "gp"), data = rilt_data, family = "binomial")
gp_fit_lin <- predict(uni_gpr1, newdata = rilt_data, type = "link", se.fit = TRUE)

mycurvefits <- data.frame("Median" = plogis(gp_fit_lin$fit), "Lower" = plogis(gp_fit_lin$fit - 1.96*gp_fit_lin$se.fit), "Upper" = plogis(gp_fit_lin$fit + 1.96*gp_fit_lin$se.fit), "x" = rilt_data$VQ20, "Mean" = NA);
mycurvefits$Model <- "GPR"

mymodel <- gamlss(LungToxicityBool ~ pb(VQ20, control = pb.control(order = 0)), data = rilt_data, family = "BB");
preds <- predict(mymodel, se.fit = TRUE);
mycurvefits2 <- data.frame("Median" = plogis(preds$fit), "Lower" = plogis(preds$fit - 1.96*preds$se.fit), "Upper" = plogis(preds$fit + 1.96*preds$se.fit), "x" = rilt_data$VQ20, "Mean" = NA);
mycurvefits2$Model <- "Pspline"

loessfit <- predict(loess(LungToxicityBool ~ VQ20, data = rilt_data), se = T)
mycurvefits_loess <- data.frame("Median" = loessfit$fit, "Lower" = loessfit$fit - 1.96*loessfit$se.fit, "Upper" = loessfit$fit + 1.96*loessfit$se.fit, "x" = rilt_data$VQ20, "Mean" = NA);
mycurvefits_loess$Model <- "LOESS"

fulldat <- rbind(curve_estim1, mycurvefits, mycurvefits2)

uni_hpr2 <- hpr(y = y, X = X, Z = Z, family = "binomial", monotonic_terms = c(1), monotonic_approach = "abs", c = 1)
coeff_estims_hpr <- get_betas(uni_hpr2, alpha = 0.05, var_names = c("ADL", "RightLung"))
pred_estim <- get_preds(uni_hpr2, alpha = 0.05)
hpr_resid <- data.frame("Residual" = rilt_data$LungToxicityBool - pred_estim$Median, "Model" = "HPR", "x" = rilt_data$VQ20)

uni_gpr2 <- gam(LungToxicityBool ~ s(VQ20, bs = "gp") + factor(Structure) + AD2L, data = rilt_data, family = "binomial")
pred_estim2 <- predict(uni_gpr2, newdata = rilt_data)
gpr_resid <- data.frame("Residual" = rilt_data$LungToxicityBool - plogis(pred_estim2), "Model" = "GPR", "x" = rilt_data$VQ20)

coeff_estims_gpr <- data.frame("Variable" = c("RightLung", "ADL"), "Median" = exp(summary(uni_gpr2)$p.coeff[-1]), "Lower" = exp(summary(uni_gpr2)$p.coeff[-1] - 1.96*summary(uni_gpr2)$se[2:3]), "Upper" = exp(summary(uni_gpr2)$p.coeff[-1] + 1.96*summary(uni_gpr2)$se[2:3]))

mymodel2 <- gamlss(LungToxicityBool ~ pb(VQ20, control = pb.control(order = 0)) + factor(Structure) + AD2L, data = rilt_data, family = "BB");
preds2 <- predict(mymodel2);
pspline_resid <- data.frame("Residual" = rilt_data$LungToxicityBool - plogis(preds2), "Model" = "Pspline", "x" = rilt_data$VQ20)

coeff_estims_pspline <- data.frame("Variable" = c("RightLung", "ADL"), "Median" = exp(summary(mymodel2)[3:4,1]), "Lower" = exp(summary(mymodel2)[3:4,1] - 1.96*summary(mymodel2)[3:4,2]), "Upper" = exp(summary(mymodel2)[3:4,1] + 1.96*summary(mymodel2)[3:4,2]))

resid_full <- rbind(hpr_resid, gpr_resid, pspline_resid)
pretty_coeffs <- data.frame("Model" = c("HPR", "GPR", "Pspline"), "ADL" = c(paste0(round(coeff_estims_hpr$Median[1], digits = 2), " (", round(coeff_estims_hpr$Lower[1], digits = 2), ", ", round(coeff_estims_hpr$Upper[1], digits = 2), ")"), paste0(round(coeff_estims_gpr$Median[2], digits = 2), " (", round(coeff_estims_gpr$Lower[2], digits = 2), ", ", round(coeff_estims_gpr$Upper[2], digits = 2), ")"), paste0(round(coeff_estims_pspline$Median[2], digits = 2), " (", round(coeff_estims_pspline$Lower[2], digits = 2), ", ", round(coeff_estims_pspline$Upper[2], digits = 2), ")")), "RightLung" = c(paste0(round(coeff_estims_hpr$Median[2], digits = 2), " (", round(coeff_estims_hpr$Lower[2], digits = 2), ", ", round(coeff_estims_hpr$Upper[2], digits = 2), ")"), paste0(round(coeff_estims_gpr$Median[1], digits = 2), " (", round(coeff_estims_gpr$Lower[1], digits = 2), ", ", round(coeff_estims_gpr$Upper[1], digits = 2), ")"), paste0(round(coeff_estims_pspline$Median[1], digits = 2), " (", round(coeff_estims_pspline$Lower[1], digits = 2), ", ", round(coeff_estims_pspline$Upper[1], digits = 2), ")")))

unadj_plot <- ggplot() + geom_line(data = fulldat, aes(x = x, y = Median, color = Model), size=1) + geom_ribbon(data = fulldat, aes(x = x, ymin = Lower, ymax = Upper, fill = Model), alpha = 0.2) + geom_point(data = rilt_data, aes(x = `low VQ 20`, y = LungToxicityBool)) + theme_bw() + ylab("Probability of RILT") + xlab("V/Q 20 (%)") + scale_x_continuous(breaks = seq(0, 0.4, by = 0.1), labels = seq(0, 0.4, by = 0.1)*100)

ggsave("unadj_plot.pdf", unadj_plot, width = 6, height = 6)

adj_plot <- ggplot() + geom_point(data = resid_full, aes(x = x, y = Residual)) + theme_bw() + facet_wrap(~ Model, nrow = 1) + ylab("Residual") + xlab("V/Q 20 (%)") + scale_x_continuous(breaks = seq(0, 0.4, by = 0.1), labels = seq(0, 0.4, by = 0.1)*100) + geom_smooth(data = resid_full, aes(x = x, y = Residual))

ggsave("adj_plot.pdf", adj_plot, width = 6, height = 6)

row.names(pretty_coeffs) <- NULL
kable(pretty_coeffs, col.names = c("Model", "ADL", "Right Lung"))
```

Things I could change:

- I could also constrain this to be monotonic, but I haven't done that yet and the fit doesn't seem to suffer that much for it.

- I could try modeling ADL as a second HPR term. 
